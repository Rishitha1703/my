name: Fix Vulnerable Firewall Port (RHEL + Ubuntu)

on:
  workflow_dispatch:

jobs:
  fix-firewall:
    runs-on: ansible-host

    vars:
      vulnerable_port: "80"

    steps:
      # -------------------------------------------------------
      # Detect OS
      # -------------------------------------------------------
      - name: Get OS Information
        ansible.builtin.setup:

      - name: Show OS Family
        ansible.builtin.debug:
          var: ansible_facts['os_family']

      # -------------------------------------------------------
      # RHEL / CENTOS (firewalld)
      # -------------------------------------------------------
      - name: Ensure SSH allowed (RHEL)
        ansible.builtin.command: firewall-cmd --add-service=ssh --permanent
        when: ansible_facts['os_family'] == "RedHat"

      - name: Start firewalld (RHEL)
        ansible.builtin.service:
          name: firewalld
          state: started
          enabled: yes
        when: ansible_facts['os_family'] == "RedHat"

      - name: Remove vulnerable port (RHEL)
        ansible.builtin.command: firewall-cmd --remove-port={{ vulnerable_port }}/tcp --permanent
        when: ansible_facts['os_family'] == "RedHat"

      - name: Reload firewall (RHEL)
        ansible.builtin.command: firewall-cmd --reload
        when: ansible_facts['os_family'] == "RedHat"

      # -------------------------------------------------------
      # UBUNTU (UFW)
      # -------------------------------------------------------
      - name: Allow SSH on UFW (Ubuntu)
        ansible.builtin.command: ufw allow 22/tcp
        when: ansible_facts['os_family'] == "Debian"

      - name: Enable UFW safely (Ubuntu)
        ansible.builtin.command: yes | ufw enable
        when: ansible_facts['os_family'] == "Debian"

      - name: Remove vulnerable port (Ubuntu)
        ansible.builtin.command: ufw deny {{ vulnerable_port }}
        when: ansible_facts['os_family'] == "Debian"

      - name: Reload UFW (Ubuntu)
        ansible.builtin.command: ufw reload
        when: ansible_facts['os_family'] == "Debian"

      # -------------------------------------------------------
      # Verification
      # -------------------------------------------------------
      - name: Verify firewall rules (RHEL)
        ansible.builtin.command: firewall-cmd --list-ports
        register: rhel_verify
        when: ansible_facts['os_family'] == "RedHat"

      - name: Print RHEL firewall ports
        ansible.builtin.debug:
          var: rhel_verify.stdout
        when: ansible_facts['os_family'] == "RedHat"

      - name: Verify firewall rules (Ubuntu)
        ansible.builtin.command: ufw status numbered
        register: ubuntu_verify
        when: ansible_facts['os_family'] == "Debian"

      - name: Print Ubuntu firewall ports
        ansible.builtin.debug:
          var: ubuntu_verify.stdout
        when: ansible_facts['os_family'] == "Debian"
