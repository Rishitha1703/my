---
- name: Fix open port vulnerability on Linux servers
  hosts: all
  become: yes
  tasks:

    - name: Check OS family
      ansible.builtin.debug:
        msg: "Detected OS Family: {{ ansible_os_family }}"

    # === FIREWALLD SECTION (for RHEL/CentOS/Fedora) ===
    - name: Ensure firewalld is installed and running
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"

    - name: List current open ports (firewalld)
      ansible.builtin.command: firewall-cmd --list-ports
      register: fw_ports
      changed_when: false
      when: ansible_os_family == "RedHat"

    - name: Close vulnerable port 80/tcp (firewalld)
      ansible.builtin.command: firewall-cmd --remove-port=80/tcp --permanent
      when: ansible_os_family == "RedHat"

    - name: Reload firewalld to apply changes
      ansible.builtin.command: firewall-cmd --reload
      when: ansible_os_family == "RedHat"

    # === UFW SECTION (for Ubuntu/Debian) ===
    - name: Ensure ufw is installed
      ansible.builtin.package:
        name: ufw
        state: present
      when: ansible_os_family == "Debian"

    - name: Enable ufw if not active
      ansible.builtin.command: ufw enable
      when: ansible_os_family == "Debian"

    - name: Deny port 80/tcp using ufw
      ansible.builtin.command: ufw deny 80/tcp
      when: ansible_os_family == "Debian"

    - name: Reload ufw rules
      ansible.builtin.command: ufw reload
      when: ansible_os_family == "Debian"

    # === Verification ===
    - name: Display updated firewall rules
      ansible.builtin.shell: |
        if [ "{{ ansible_os_family }}" == "RedHat" ]; then
          firewall-cmd --list-ports
        else
          ufw status
        fi
      register: fw_status

    - name: Show firewall status
      ansible.builtin.debug:
        msg: "{{ fw_status.stdout }}"
